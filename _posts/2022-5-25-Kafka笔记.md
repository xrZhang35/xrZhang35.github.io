# Kafak

## 一、消息引擎系统概述

### 1. 什么是消息队列，或者讲消息引擎

是一组规范，企业利用这组规范来在不同系统之间传递消息，达到松耦合和异步的目的

### 2. 如何设计一个消息引擎

-   如何设计消息

    -   采用现有的序列化协议
    -   自定义二进制字节流，kafka就是这么做的

-   采用何种方式传输

    -   点对点模型

        kafka实现细节：引入消费者组的概念，只会被一个组中的一个消费者消费，提升消费端的吞吐量

        重平衡：如果一个失败，则转移给消费者组的其他组员

        区别分区位移和消费者位移

    -   发布-订阅模型

        >   Topic 可以理解成逻辑语义相近的消息容器
        >
        >   Publisher
        >
        >   Subscriber

### 3. Kafka和JMS的关系

JMS像一组API，Kafka遵照JMS规范

### 4. 消息引擎的作用是什么

-   松耦合

-   异步化

-   削峰填谷

    >   所谓的“削峰填谷”就是指缓冲上下游瞬时突发流量，使其更平滑。特别是对于那种发送能力很强的上游系统，如果没有消息引擎的保护，“脆弱”的下游系统可能会直接被压垮导致全链路服务“雪崩”。但是，一旦有了消息引擎，它能够有效地对抗上游的流量冲击，真正做到将上游的“峰”填满到“谷”中，避免了流量的震荡。

## 二、kafka术语

-   Topic

    发布订阅的对象

-   Clients

    -   Producer
    -   Consumer

-   Broker

### 1. 如何实现kafka高可用

-   分布式
-   Replication
    -   Leader
    -   Follower

### 2. 副本的工作机制

生产者总是向领导者副本写入数据，消费者总是从领导者副本读消息

而追随者副本则只会像领导者副本发送请求，请求将最新生产的消息发给他

### 3. 如何解决伸缩性问题

>   什么是伸缩性问题，对于kafka来说就是怎么消息太多了一台机器的broker处理不完了怎么办

分片。Partion  Sharding  Region

### 4. 怎么理解副本和分区的联系呢

副本是在分区这个层级定义的。每个分区下可以配置若干个副本，其中只能有 1 个领导者副本和 N-1 个追随者副本。生产者向分区写入消息，每条消息在分区中的位置信息由一个叫位移（Offset）的数据来表征。分区位移总是从 0 开始，假设一个生产者向一个空分区写入了 10 条消息，那么这 10 条消息的位移依次是 0、1、2、…、9。

### 5. Kafka的三层消息架构

-   第一层是主题层，每个主题可以配置 M 个分区，而每个分区又可以配置 N 个副本。
-   第二层是分区层，每个分区的 N 个副本中只能有一个充当领导者角色，对外提供服务；其他 N-1 个副本是追随者副本，只是提供数据冗余之用。
-   第三层是消息层，分区中包含若干条消息，每条消息的位移从 0 开始，依次递增。
-   最后，客户端程序只能与分区的领导者副本进行交互。

### 6. kafka如何持久化数据的

日志，好处在于顺序IO操作

kafka文件过大怎么处理，通过日志段机制。

在 Kafka 底层，一个日志又近一步细分成多个日志段，消息被追加写到当前最新的日志段中，当写满了一个日志段后，Kafka 会自动切分出一个新的日志段，并将老的日志段封存起来。Kafka 在后台还有定时任务会定期地检查老的日志段是否能够被删除，从而实现回收磁盘空间的目的。

![](http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Kafka%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98/assets/06dbe05a9ed4e5bcc191bbdb985352df.png)

## 三、kafka的作用

kafka不仅是一个消息引擎系统，也是一个分布式流处理平台

kafka在设计之初就旨在提供三方面的特性：

-   提供一套API来实现生产者和消费者
-   降低网络传输和磁盘存储开销
-   实现高伸缩性架构

## 四、Kafka的种类

-   Apache Kafka

    优点：社区响应快

    缺点：仅提供最基础的功能，例如只提供一种读写磁盘文件的连接器，不提供监控组件

-   Confluent Kafka

    优点：提供了更全的一些功能

    缺点：不打算发展国内

-   CDH/HDP Kafka

    优点：提供前端界面和监控面板

    缺点：发展慢，不了解底层

## 五、Kafka版本号问题

-   0.7

    只提供了基础的消息队列机制

-   0.8

    副本机制

-   0.9

    增加了基础的安全认证/权限功能

    重写客户端

    引入Kafka Connect

-   0.10

    引入Kaka Streams

-   0.11

    提供幂等性Producer API和事务API

    对Kafka消息格式做了重构

-   1.0和2.0

    对Kafka Streams的巨大改进

